{% extends "base.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1>Admin Dashboard</h1>
    
    {% if current_user.is_admin %}
    <!-- User Creation Form -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Create New User</h5>
            <form id="createUserForm" method="POST" action="{{ url_for('auth.create_user') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <input type="text" name="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="col-auto">
                        <input type="email" name="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="col-auto">
                        <input type="password" name="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div class="col-auto">
                        <select name="security_level" class="form-select" required>
                            <option value="" disabled selected>Select Role</option>
                            <option value="0">User</option>
                            <option value="1">Supervisor</option>
                            <option value="2">Manager</option>
                            <option value="3">Admin</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Password Change Form -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Change Password</h5>
            <form id="changePasswordForm" method="POST" action="{{ url_for('auth.change_password') }}">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <input type="password" name="new_password" class="form-control" placeholder="New Password" required>
                    </div>
                    <div class="col-auto">
                        <input type="password" name="confirm_password" class="form-control" placeholder="Confirm New Password" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% if current_user.is_admin %}
    <!-- Import Section -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title mb-0">Import Data from Salesforce</h5>
            <p class="text-muted mb-3">Select data to import from Salesforce into the system. For best results, import in the suggested order.</p>
            
            <!-- Add Import All button -->
            <div class="mb-4">
                <button onclick="importAllSequentially()" class="btn admin-btn-import" id="importAllBtn">
                    <i class="fas fa-download"></i>
                    <span>Import All Data Sequentially</span>
                </button>
                <div class="import-status" id="importAllStatus"></div>
                <div class="import-progress" id="importAllProgress">
                    <div class="import-progress-bar"></div>
                </div>
            </div>

            <div class="import-grid">
                <!-- 1. Organizations -->
                <div class="import-item">
                    <button onclick="importOrganizations()" class="btn admin-btn-import" id="importOrganizationsBtn">
                        <i class="fas fa-building"></i>
                        <span>1. Import Organizations</span>
                    </button>
                    <div class="import-status" id="importOrganizationsStatus"></div>
                    <div class="import-progress" id="importOrganizationsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 2. Schools -->
                <div class="import-item">
                    <button onclick="importSchools()" class="btn admin-btn-import" id="importSchoolsBtn">
                        <i class="fas fa-school"></i>
                        <span>2. Import Schools</span>
                    </button>
                    <div class="import-status" id="importSchoolsStatus"></div>
                    <div class="import-progress" id="importSchoolsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 3. Classes -->
                <div class="import-item">
                    <button onclick="importClasses()" class="btn admin-btn-import" id="importClassesBtn">
                        <i class="fas fa-file-import"></i>
                        <span>3. Import Classes</span>
                    </button>
                    <div class="import-status" id="importClassesStatus"></div>
                    <div class="import-progress" id="importClassesProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 4. Teachers -->
                <div class="import-item">
                    <button onclick="importTeachers()" class="btn admin-btn-import" id="importTeachersBtn">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>4. Import Teachers</span>
                    </button>
                    <div class="import-status" id="importTeachersStatus"></div>
                    <div class="import-progress" id="importTeachersProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 5. Students -->
                <div class="import-item">
                    <button onclick="importStudents()" class="btn admin-btn-import" id="importStudentsBtn">
                        <i class="fas fa-user-graduate"></i>
                        <span>5. Import Students</span>
                    </button>
                    <div class="import-status" id="importStudentsStatus"></div>
                    <div class="import-progress" id="importStudentsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 6. Volunteers -->
                <div class="import-item">
                    <button onclick="importVolunteers()" class="btn admin-btn-import" id="importVolunteersBtn">
                        <i class="fas fa-users"></i>
                        <span>6. Import Volunteers</span>
                    </button>
                    <div class="import-status" id="importVolunteersStatus"></div>
                    <div class="import-progress" id="importVolunteersProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 6a. Volunteer-Organization Affiliations -->
                <div class="import-item">
                    <button onclick="importAffiliations()" class="btn admin-btn-import" id="importAffiliationsBtn">
                        <i class="fas fa-link"></i>
                        <span>6a. Import Affiliations</span>
                    </button>
                    <div class="import-status" id="importAffiliationsStatus"></div>
                    <div class="import-progress" id="importAffiliationsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 7. Events -->
                <div class="import-item">
                    <button onclick="importEvents()" class="btn admin-btn-import" id="importEventsBtn">
                        <i class="fas fa-calendar"></i>
                        <span>7. Import Events</span>
                    </button>
                    <div class="import-status" id="importEventsStatus"></div>
                    <div class="import-progress" id="importEventsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
                
                <!-- 8. History -->
                <div class="import-item">
                    <button onclick="importHistory()" class="btn admin-btn-import" id="importHistoryBtn">
                        <i class="fas fa-history"></i>
                        <span>8. Import History</span>
                    </button>
                    <div class="import-status" id="importHistoryStatus"></div>
                    <div class="import-progress" id="importHistoryProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                <!-- 9. Pathways -->
                <div class="import-item">
                    <button onclick="importPathways()" class="btn admin-btn-import" id="importPathwaysBtn">
                        <i class="fas fa-road"></i>
                        <span>9. Import Pathways</span>
                    </button>
                    <div class="import-status" id="importPathwaysStatus"></div>
                    <div class="import-progress" id="importPathwaysProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                <!-- 9a. Pathway Participants -->
                <div class="import-item">
                    <button onclick="importPathwayParticipants()" class="btn admin-btn-import" id="importPathwayParticipantsBtn">
                        <i class="fas fa-users"></i>
                        <span>9a. Import Pathway Participants</span>
                    </button>
                    <div class="import-status" id="importPathwayParticipantsStatus"></div>
                    <div class="import-progress" id="importPathwayParticipantsProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>

                <!-- 10. Virtual Events -->
                <div class="import-item">
                    <button onclick="importVirtualEvents()" class="btn admin-btn-import" id="importVirtualBtn">
                        <i class="fas fa-video"></i>
                        <span>10. Import Virtual Events</span>
                    </button>
                    <div class="import-status" id="importVirtualStatus"></div>
                    <div class="import-progress" id="importVirtualProgress">
                        <div class="import-progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Volunteer Management Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Volunteer Management</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-grid gap-2">
                        <button id="updateLocalStatus" class="btn btn-primary">
                            <i class="fa-solid fa-location-dot"></i> Update Volunteer Local Statuses
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purge Data Section -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title text-danger mb-0">Purge Data</h5>
            <p class="text-muted mb-3">Warning: These actions will permanently delete data from the system. This cannot be undone.</p>
            <div class="purge-grid">
                <div class="purge-item">
                    <button onclick="purgeVolunteers()" class="btn admin-btn-danger" id="purgeVolunteersBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge All Volunteer Data</span>
                    </button>
                    <div class="purge-status" id="purgeVolunteersStatus"></div>
                </div>
                <div class="purge-item">
                    <button onclick="purgeEvents()" class="btn admin-btn-danger" id="purgeEventsBtn">
                        <i class="fas fa-trash-alt"></i>
                        <span>Purge All Events</span>
                    </button>
                    <div class="purge-status" id="purgeEventsStatus"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Cache Management -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Report Cache Management</h5>
            <button onclick="refreshDistrictReport()" class="btn admin-btn-import" id="refreshDistrictReportBtn">
                <i class="fas fa-sync"></i>
                <span>Refresh District Year-End Report Cache</span>
            </button>
            <div class="import-status" id="refreshDistrictReportStatus"></div>
        </div>
    </div>

    <!-- System Management -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">System Management</h5>
            <a href="{{ url_for('management.bug_reports') }}" class="btn btn-primary">
                <i class="fas fa-bug"></i> View Bug Reports
            </a>
        </div>
    </div>
    {% endif %}
    <!-- Toast Container for Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Users Table -->
    <div class="card admin-card mt-4">
        <div class="card-body">
            <h5 class="card-title">Current Users</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.created_at|format_date }}</td>
                            <td>
                                {% if user.is_admin %}
                                <button onclick="deleteUser('{{ user.id }}')" class="btn admin-btn-danger btn-sm">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('updateLocalStatus').addEventListener('click', function() {
    if (confirm('Are you sure you want to update local statuses for all volunteers? This may take a few moments.')) {
        this.disabled = true;
        this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Updating...';
        
        fetch('/volunteers/update-local-statuses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating local statuses: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fa-solid fa-location-dot"></i> Update Volunteer Local Statuses';
        });
    }
});
</script>
<script>
function deleteUser(userId) {
    console.log('Delete function called with userId:', userId);
    if (confirm('Are you sure you want to delete this user?')) {
        console.log('Delete confirmed, sending request...');
        fetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Response received:', response);
            if (response.ok) {
                window.location.reload();
            } else {
                response.json().then(data => {
                    alert(data.error || 'Error deleting user');
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

function importClasses() {
    if (confirm('Are you sure you want to import classes from Salesforce?')) {
        fetch('/management/import-classes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing classes: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing classes: ${error.message}`);
        });
    }
}

function importSchools() {
    if (confirm('Are you sure you want to import schools from Salesforce?')) {
        fetch('/management/import-schools', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing schools: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing schools: ${error.message}`);
        });
    }
}

function importVolunteers() {
    if (confirm('Are you sure you want to import volunteers from Salesforce?')) {
        fetch('/volunteers/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing volunteers: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing volunteers: ${error.message}`);
        });
    }
}

function importEvents() {
    if (confirm('Are you sure you want to import events from Salesforce?')) {
        fetch('/events/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing events: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing events: ${error.message}`);
        });
    }
}

function importOrganizations() {
    if (confirm('Are you sure you want to import organizations from Salesforce?')) {
        fetch('/organizations/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing organizations: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing organizations: ${error.message}`);
        });
    }
}

function importTeachers() {
    if (confirm('Are you sure you want to import teachers from Salesforce?')) {
        fetch('/attendance/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing teachers: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing teachers: ${error.message}`);
        });
    }
}

function importStudents() {
    if (confirm('Are you sure you want to import students from Salesforce?')) {
        fetch('/attendance/import-students-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing students: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing students: ${error.message}`);
        });
    }
}

function importHistory() {
    if (confirm('Are you sure you want to import history from Salesforce?')) {
        fetch('/history/import-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing history: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing history: ${error.message}`);
        });
    }
}

function importAffiliations() {
    if (confirm('Are you sure you want to import volunteer-organization affiliations from Salesforce?')) {
        fetch('/organizations/import-affiliations-from-salesforce', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                // Show detailed error message
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                console.error('Import error:', data);
                alert(`Error importing affiliations: ${errorMessage}`);
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            alert(`Error importing affiliations: ${error.message}`);
        });
    }
}

function purgeVolunteers() {
    if (!confirm('WARNING: This will permanently delete ALL volunteer data from the system. This action cannot be undone. Are you sure you want to continue?')) {
        return;
    }

    const btn = document.getElementById('purgeVolunteersBtn');
    const status = document.getElementById('purgeVolunteersStatus');
    
    btn.disabled = true;
    status.textContent = 'Purging volunteer data...';
    status.className = 'purge-status';

    fetch('/volunteers/purge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Successfully purged all volunteer data';
            status.classList.add('success');
            showToast('Success', 'All volunteer data has been purged from the system', 'success');
        } else {
            throw new Error(data.error || 'Failed to purge volunteer data');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        status.classList.add('error');
        showToast('Error', 'Failed to purge volunteer data: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function purgeEvents() {
    if (confirm('WARNING: This will permanently delete ALL events and their participations. This action cannot be undone. Are you sure you want to continue?')) {
        document.getElementById('purgeEventsBtn').disabled = true;
        document.getElementById('purgeEventsBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Purging...';
        
        fetch('/events/purge', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('All events have been successfully purged.');
            } else {
                alert('Error purging events: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error purging events: ' + error);
        })
        .finally(() => {
            document.getElementById('purgeEventsBtn').disabled = false;
            document.getElementById('purgeEventsBtn').innerHTML = '<i class="fas fa-trash-alt"></i> Purge All Events';
        });
    }
}

async function importAllSequentially() {
    const importAllBtn = document.getElementById('importAllBtn');
    const importAllStatus = document.getElementById('importAllStatus');
    const importAllProgress = document.getElementById('importAllProgress');
    const progressBar = importAllProgress.querySelector('.import-progress-bar');
    
    // Define the import sequence with routes and button IDs
    const importSequence = [
        { route: '/organizations/import-from-salesforce', name: 'Organizations', btnId: 'importOrganizationsBtn' },
        { route: '/management/import-schools', name: 'Schools', btnId: 'importSchoolsBtn' },
        { route: '/management/import-classes', name: 'Classes', btnId: 'importClassesBtn' },
        { route: '/attendance/import-from-salesforce', name: 'Teachers', btnId: 'importTeachersBtn' },
        { route: '/attendance/import-students-from-salesforce', name: 'Students', btnId: 'importStudentsBtn' },
        { route: '/volunteers/import-from-salesforce', name: 'Volunteers', btnId: 'importVolunteersBtn' },
        { route: '/organizations/import-affiliations-from-salesforce', name: 'Affiliations', btnId: 'importAffiliationsBtn' },
        { route: '/events/import-from-salesforce', name: 'Events', btnId: 'importEventsBtn' },
        { route: '/history/import-from-salesforce', name: 'History', btnId: 'importHistoryBtn' },
        { route: '/pathways/import-from-salesforce', name: 'Pathways', btnId: 'importPathwaysBtn' }
    ];

    // Disable all import buttons
    importSequence.forEach(item => {
        const btn = document.getElementById(item.btnId);
        if (btn) btn.disabled = true;
    });

    // Disable the main import button
    importAllBtn.disabled = true;
    importAllProgress.classList.add('active');
    
    let successCount = 0;
    let errorCount = 0;

    for (let i = 0; i < importSequence.length; i++) {
        const item = importSequence[i];
        const progress = ((i) / importSequence.length) * 100;
        progressBar.style.width = `${progress}%`;
        
        importAllStatus.textContent = `Importing ${item.name}...`;
        
        try {
            const response = await fetch(item.route, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                successCount++;
                const btn = document.getElementById(item.btnId);
                if (btn) {
                    btn.style.backgroundColor = 'var(--ucla-blue)';
                    btn.style.opacity = '0.7';
                }
            } else {
                errorCount++;
                throw new Error(data.message || data.error || `Failed to import ${item.name}`);
            }
        } catch (error) {
            console.error(`Error importing ${item.name}:`, error);
            errorCount++;
        }
    }

    // Complete the progress bar
    progressBar.style.width = '100%';
    
    // Update final status
    importAllStatus.textContent = `Import complete: ${successCount} successful, ${errorCount} failed`;
    
    // Re-enable all buttons
    importSequence.forEach(item => {
        const btn = document.getElementById(item.btnId);
        if (btn) btn.disabled = false;
    });
    importAllBtn.disabled = false;

    // Show completion toast
    showToast(
        errorCount === 0 ? 'Success' : 'Complete with Errors',
        `Import sequence completed: ${successCount} successful, ${errorCount} failed`,
        errorCount === 0 ? 'success' : 'error'
    );
}

// Add this helper function if you don't already have it
function showToast(title, message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <div>
            <strong>${title}</strong>
            <div>${message}</div>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Remove toast after 5 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function refreshDistrictReport() {
    if (!confirm('Are you sure you want to refresh the district year-end report cache?')) {
        return;
    }
    
    const btn = document.getElementById('refreshDistrictReportBtn');
    const status = document.getElementById('refreshDistrictReportStatus');
    
    btn.disabled = true;
    status.textContent = 'Refreshing report cache...';
    
    // Get current school year
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1; // JavaScript months are 0-based
    const schoolYear = month < 6 ? 
        `${(year-1).toString().slice(-2)}${year.toString().slice(-2)}` : 
        `${year.toString().slice(-2)}${(year+1).toString().slice(-2)}`;
    
    fetch(`/reports/district/year-end/refresh?school_year=${schoolYear}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = 'Successfully refreshed report cache';
            showToast('Success', `Report cache has been refreshed for ${schoolYear.slice(0,2)}-${schoolYear.slice(2)} school year`, 'success');
        } else {
            throw new Error(data.error || 'Failed to refresh report cache');
        }
    })
    .catch(error => {
        status.textContent = 'Error: ' + error.message;
        showToast('Error', 'Failed to refresh report cache: ' + error.message, 'error');
    })
    .finally(() => {
        btn.disabled = false;
    });
}

function importVirtualEvents() {
    if (confirm('Are you sure you want to import virtual events from the Google Sheet?')) {
        const btn = document.getElementById('importVirtualBtn');
        const status = document.getElementById('importVirtualStatus');
        const progress = document.getElementById('importVirtualProgress');
        
        btn.disabled = true;
        status.textContent = 'Importing...';
        
        // Get current date to determine academic year
        const today = new Date();
        const month = today.getMonth() + 1; // JavaScript months are 0-based
        const year = today.getFullYear();
        const academicYear = month < 8 ? year : year;
        
        fetch('/virtual/import-sheet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                academic_year: academicYear
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                status.textContent = `Import completed: ${data.successCount} successful, ${data.warningCount} warnings, ${data.errorCount} errors`;
                if (data.errors && data.errors.length > 0) {
                    console.log('Import errors:', data.errors);
                    // Display errors in the status
                    const errorList = data.errors.join('\n');
                    status.innerHTML = `${status.textContent}<br><small class="text-danger">${errorList}</small>`;
                }
                showToast('Success', `Import completed successfully with ${data.successCount} records`, 'success');
            } else {
                throw new Error(data.error || 'Failed to import virtual events');
            }
        })
        .catch(error => {
            console.error('Import error:', error);
            status.textContent = `Error: ${error.message}`;
            showToast('Error', `Failed to import virtual events: ${error.message}`, 'error');
        })
        .finally(() => {
            btn.disabled = false;
        });
    }
}

function importPathways() {
    // Disable the button and show loading state
    const button = document.getElementById('importPathwaysBtn');
    const status = document.getElementById('importPathwaysStatus');
    const progress = document.getElementById('importPathwaysProgress');
    
    button.disabled = true;
    status.textContent = 'Importing pathways...';
    progress.style.display = 'block';
    
    // Make the API call
    fetch('/pathways/import-from-salesforce', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = data.message;
            status.style.color = 'green';
        } else {
            status.textContent = data.message || 'Import failed';
            status.style.color = 'red';
        }
        
        // Show errors if any
        if (data.errors && data.errors.length > 0) {
            console.log('Import errors:', data.errors);
        }
    })
    .catch(error => {
        status.textContent = 'Import failed: ' + error.message;
        status.style.color = 'red';
        console.error('Import error:', error);
    })
    .finally(() => {
        button.disabled = false;
        progress.style.display = 'none';
    });
}

function importPathwayParticipants() {
    // Disable the button and show loading state
    const button = document.getElementById('importPathwayParticipantsBtn');
    const status = document.getElementById('importPathwayParticipantsStatus');
    const progress = document.getElementById('importPathwayParticipantsProgress');
    
    button.disabled = true;
    status.textContent = 'Importing pathway participants...';
    progress.style.display = 'block';
    
    // Make the API call
    fetch('/pathways/import-participants-from-salesforce', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = data.message;
            status.style.color = 'green';
        } else {
            status.textContent = data.message || 'Import failed';
            status.style.color = 'red';
        }
        
        // Show errors if any
        if (data.errors && data.errors.length > 0) {
            console.log('Import errors:', data.errors);
        }
    })
    .catch(error => {
        status.textContent = 'Import failed: ' + error.message;
        status.style.color = 'red';
        console.error('Import error:', error);
    })
    .finally(() => {
        button.disabled = false;
        progress.style.display = 'none';
    });
}
</script>
{% endblock %}